{% extends "base.html" %}

{% block title %}AI Chat{% endblock %}
{% block nav_chat %}active{% endblock %}

{% block head %}
<style>
    /* Chat-specific styles */
    .chat-container {
        height: calc(100vh - 4rem);
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--glass-border);
        padding: 1rem 2rem;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .message {
        display: flex;
        gap: 1rem;
        animation: slideUp 0.3s ease-out;
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .message.user .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .message-content {
        max-width: 70%;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 1rem;
        padding: 1rem 1.5rem;
    }

    .message.user .message-content {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
    }

    .chat-input-area {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-top: 1px solid var(--glass-border);
        padding: 1.5rem 2rem;
    }

    .typing-indicator {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(139, 92, 246, 0.8);
        animation: typingBounce 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }

    @media (max-width: 768px) {
        .chat-messages {
            padding: 1rem;
        }

        .message-content {
            max-width: 85%;
        }

        .chat-header {
            padding: 1rem;
        }

        .model-selectors {
            flex-direction: column !important;
            gap: 0.5rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-gradient">
                    <i class="fas fa-comments mr-2"></i>AI Chat
                </h1>
                <div class="flex items-center gap-2 text-sm">
                    <div class="status-dot running" id="cluster-status"></div>
                    <span id="cluster-info" class="text-gray-300">Checking cluster...</span>
                </div>
            </div>

            <div class="model-selectors flex flex-wrap gap-3">
                <!-- Model Selector -->
                <select id="model-selector" class="select-glass text-sm">
                    <option value="">Loading models...</option>
                </select>

                <!-- Quick Actions -->
                <button onclick="newChat()" class="btn-glass text-sm">
                    <i class="fas fa-plus mr-2"></i>New Chat
                </button>
                <button onclick="clearChat()" class="btn-glass text-sm">
                    <i class="fas fa-trash mr-2"></i>Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Messages Area -->
    <div id="chat-messages" class="chat-messages">
        <!-- Welcome Message -->
        <div class="message assistant">
            <div class="message-avatar">
                <i class="fas fa-robot text-purple-300"></i>
            </div>
            <div class="message-content">
                <div class="text-white mb-2 font-semibold">AI Assistant</div>
                <div class="text-gray-200">
                    <p class="mb-3">Welcome! I'm connected to your Ollama cluster with <span id="model-count">loading...</span> models available.</p>
                    <p class="text-sm text-gray-300">Select a model above and start chatting!</p>
                </div>
                <div class="text-xs text-gray-400 mt-2">Just now</div>
            </div>
        </div>
    </div>

    <!-- Typing Indicator -->
    <div id="typing-indicator" class="hidden px-8 pb-4">
        <div class="flex items-center gap-3">
            <div class="message-avatar">
                <i class="fas fa-robot text-purple-300"></i>
            </div>
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span class="text-sm text-gray-400">AI is thinking...</span>
        </div>
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
        <div class="max-w-5xl mx-auto">
            <div class="flex gap-3">
                <textarea
                    id="chat-input"
                    placeholder="Type your message... (Shift+Enter for new line, Enter to send)"
                    class="input-glass flex-1 resize-none"
                    rows="3"
                    onkeydown="handleKeyDown(event)"
                ></textarea>
                <button
                    id="send-btn"
                    onclick="sendMessage()"
                    class="btn-glass-primary px-6 self-end disabled:opacity-50"
                    disabled
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="flex justify-between items-center mt-2 text-sm text-gray-400">
                <div id="char-count">0 / 4000</div>
                <div id="model-info"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentModel = null;
    let conversationHistory = [];
    let isGenerating = false;

    // Load models on page load
    async function loadModels() {
        try {
            const response = await fetch('/api/ollama/models');
            const data = await response.json();

            const selector = document.getElementById('model-selector');
            selector.innerHTML = '<option value="">Select a model...</option>';

            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                const sizeMB = (model.size / (1024 * 1024)).toFixed(0);
                option.textContent = `${model.name} (${sizeMB}MB) - ${model.node}`;
                selector.appendChild(option);
            });

            document.getElementById('model-count').textContent = `${data.count}`;

            // Check cluster health
            checkClusterHealth();
        } catch (error) {
            console.error('Failed to load models:', error);
            document.getElementById('model-selector').innerHTML = '<option>Error loading models</option>';
        }
    }

    async function checkClusterHealth() {
        try {
            const response = await fetch('/api/ollama/health');
            const data = await response.json();

            const statusDot = document.getElementById('cluster-status');
            const clusterInfo = document.getElementById('cluster-info');

            if (data.all_healthy) {
                statusDot.className = 'status-dot running';
                clusterInfo.textContent = `${data.healthy}/${data.total} nodes online`;
            } else {
                statusDot.className = 'status-dot loading';
                clusterInfo.textContent = `${data.healthy}/${data.total} nodes online`;
            }
        } catch (error) {
            document.getElementById('cluster-status').className = 'status-dot stopped';
            document.getElementById('cluster-info').textContent = 'Cluster offline';
        }
    }

    // Model selector change
    document.getElementById('model-selector').addEventListener('change', function(e) {
        currentModel = e.target.value;
        document.getElementById('send-btn').disabled = !currentModel || !document.getElementById('chat-input').value.trim();

        const modelInfo = document.getElementById('model-info');
        if (currentModel) {
            modelInfo.textContent = `Using: ${currentModel}`;
        } else {
            modelInfo.textContent = '';
        }
    });

    // Input change
    document.getElementById('chat-input').addEventListener('input', function(e) {
        const text = e.target.value;
        document.getElementById('char-count').textContent = `${text.length} / 4000`;
        document.getElementById('send-btn').disabled = !currentModel || !text.trim() || isGenerating;
    });

    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    async function sendMessage() {
        if (!currentModel || isGenerating) return;

        const input = document.getElementById('chat-input');
        const message = input.value.trim();

        if (!message) return;

        isGenerating = true;
        document.getElementById('send-btn').disabled = true;
        input.value = '';
        document.getElementById('char-count').textContent = '0 / 4000';

        // Add user message to UI
        addMessage('user', message);

        // Add to conversation history
        conversationHistory.push({role: 'user', content: message});

        // Show typing indicator
        document.getElementById('typing-indicator').classList.remove('hidden');

        // Scroll to bottom
        scrollToBottom();

        try {
            // Stream response from Ollama
            const response = await fetch('/api/ollama/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    model: currentModel,
                    messages: conversationHistory,
                    stream: true
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let assistantMessage = '';
            let messageElement = null;

            // Hide typing indicator
            document.getElementById('typing-indicator').classList.add('hidden');

            // Create assistant message element
            messageElement = addMessage('assistant', '', true);

            while (true) {
                const {done, value} = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));

                        if (data.error) {
                            throw new Error(data.error);
                        }

                        if (data.content) {
                            assistantMessage += data.content;
                            updateMessageContent(messageElement, assistantMessage);
                            scrollToBottom();
                        }

                        if (data.done) {
                            break;
                        }
                    }
                }
            }

            // Add to conversation history
            conversationHistory.push({role: 'assistant', content: assistantMessage});

        } catch (error) {
            console.error('Chat error:', error);
            document.getElementById('typing-indicator').classList.add('hidden');
            addMessage('assistant', `Error: ${error.message}. Please try again.`);
        } finally {
            isGenerating = false;
            document.getElementById('send-btn').disabled = !currentModel;
        }
    }

    function addMessage(role, content, streaming = false) {
        const messagesDiv = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = role === 'user'
            ? '<i class="fas fa-user text-white"></i>'
            : '<i class="fas fa-robot text-purple-300"></i>';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'text-white mb-2 font-semibold text-sm';
        nameDiv.textContent = role === 'user' ? 'You' : 'AI Assistant';

        const textDiv = document.createElement('div');
        textDiv.className = 'text-gray-200 whitespace-pre-wrap';
        textDiv.textContent = content;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'text-xs text-gray-400 mt-2';
        timeDiv.textContent = new Date().toLocaleTimeString();

        contentDiv.appendChild(nameDiv);
        contentDiv.appendChild(textDiv);
        contentDiv.appendChild(timeDiv);

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        messagesDiv.appendChild(messageDiv);

        if (streaming) {
            return textDiv;
        }

        scrollToBottom();
    }

    function updateMessageContent(element, content) {
        element.textContent = content;
    }

    function scrollToBottom() {
        const messages = document.getElementById('chat-messages');
        messages.scrollTop = messages.scrollHeight;
    }

    function newChat() {
        if (confirm('Start a new conversation? This will clear the current chat.')) {
            conversationHistory = [];
            document.getElementById('chat-messages').innerHTML = `
                <div class="message assistant">
                    <div class="message-avatar">
                        <i class="fas fa-robot text-purple-300"></i>
                    </div>
                    <div class="message-content">
                        <div class="text-white mb-2 font-semibold">AI Assistant</div>
                        <div class="text-gray-200">
                            <p>New conversation started! How can I help you today?</p>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">Just now</div>
                    </div>
                </div>
            `;
        }
    }

    function clearChat() {
        if (confirm('Clear all messages? This cannot be undone.')) {
            newChat();
        }
    }

    // Load models on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadModels();
        setInterval(checkClusterHealth, 10000); // Check health every 10 seconds
    });
</script>
{% endblock %}
